<!----
 * AURA Portfolio - DataLogs Search Results Template
 * Advanced User Repository & Archive - Enhanced Search with AJAX
 * Version: 3.0.0 - Integrated with Phase 2+ search components
---->

{% extends "blog/datalogs_base.html" %}
{% load static %}
{% load aura_filters %}
{% load aura_components %}
{% load datalog_tags %}

{% block datalogs_title %}{% if query %}Search: "{{ query }}"{% else %}Search DataLogs{% endif %}{% endblock %}

{% block show_breadcrumbs %}True{% endblock %}
{% block show_filters %}True{% endblock %}

{% block datalogs_breadcrumbs %}
<i class="fas fa-chevron-right breadcrumb-separator"></i>
<span class="breadcrumb-item active">
    <i class="fas fa-search"></i>
    <span>Search{% if query %}: "{{ query|truncate_smart:30 }}"{% endif %}</span>
</span>
{% endblock %}

{% block datalogs_content %}

<!-- Enhanced Search Interface using new component -->
<section class="search-interface-section">
    <div class="container">
        {% search_suggestions query=query style='full' enable_ajax=True max_suggestions=8 show_descriptions=True %}
    </div>
</section>

<!-- Search Results Summary -->
{% if query %}
<section class="search-results-summary">
    <div class="container">
        {% section_header title="Search Results" subtitle='for "{{ query }}"' icon="fas fa-search" show_metrics=True metric_1_value=search_metadata.total_results metric_1_label="Results Found" metric_1_icon="fas fa-database" metric_2_value=active_filters|length metric_2_label="Filters Applied" metric_2_icon="fas fa-filter" metric_3_value=search_metadata.sort_by|title metric_3_label="Sort Method" metric_3_icon="fas fa-sort" %}
    </div>
</section>
{% endif %}

<!-- Active Filters Display -->
{% if active_filters %}
<section class="active-filters-section">
    <div class="container">
        <div class="active-filters-display glass-effect">
            <div class="filters-header breadcrumb-item">
                <i class="fas fa-filter"></i>
                <span class="filters-title">Active Filters</span>
            </div>
            
            <div class="filters-list subnav-stats">
                {% for key, value in active_filters.items %}
                <div class="active-filter-item">
                    <span class="filter-name">{{ key|title }}</span>
                    <span class="filter-value">{{ value }}</span>
                    <a href="{% build_url sort=search_metadata.sort_by %}" class="remove-filter-btn">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
                
                <a href="{% url 'blog:search' %}?q={{ query }}" class="clear-all-filters-btn">
                    <i class="fas fa-times-circle"></i>
                    <span>Clear All</span>
                </a>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Search Results -->
{% if query %}
<section class="search-results-section">
    <div class="container">
        
        {% if posts %}
        <!-- Results using data grid component -->
        {% include 'components/data_grid.html' with items=posts grid_type="datalogs" columns=3 show_controls=True show_sort=True show_filters=False allow_compact=True view_mode="grid" count_label="search results" %}
        
        {% else %}
        <!-- No Results State -->
        {% glass_card title="No Results Found" icon="fas fa-search" variant="warning" %}
            
            <div class="no-results-content">
                <div class="no-results-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="no-results-title">No DataLogs found for "{{ query }}"</h3>
                <p class="no-results-message">
                    We couldn't find any DataLog entries matching your search. Try adjusting your search terms or browse our categories below.
                </p>
                
                <!-- Search suggestions for no results -->
                <div class="no-results-suggestions">
                    <h4 class="suggestions-title">Try searching for:</h4>
                    <div class="suggestion-tags">
                        {% for tag in popular_tags|slice:":8" %}
                        <a href="{% url 'blog:search' %}?q={{ tag.name }}" class="suggestion-tag">
                            <i class="fas fa-tag"></i>
                            <span>{{ tag.name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Quick actions -->
                <div class="no-results-actions subnav-stats">
                    <a href="{% url 'blog:post_list' %}" class="no-results-action-btn">
                        <i class="fas fa-list"></i>
                        <span>Browse All DataLogs</span>
                    </a>
                    <a href="{% url 'blog:categories' %}" class="no-results-action-btn">
                        <i class="fas fa-folder"></i>
                        <span>Browse Categories</span>
                    </a>
                    <a href="{% url 'blog:archive' %}" class="no-results-action-btn">
                        <i class="fas fa-calendar"></i>
                        <span>Browse Archive</span>
                    </a>
                </div>
            </div>
            
        {% endglass_card %}
        {% endif %}
        
    </div>
</section>

<!-- Enhanced Pagination -->
{% if is_paginated %}
<section class="pagination-section">
    <div class="container">
        {% render_pagination page_obj request %}
    </div>
</section>
{% endif %}

{% else %}
<!-- Search Landing Page -->
<section class="search-landing-section">
    <div class="container">
        
        <!-- Welcome Search Interface -->
        {% glass_card title="Search DataLogs Archive" subtitle="Find technical documentation and insights" icon="fas fa-search" %}
            
            <!-- Enhanced search form -->
            <form method="get" class="search-landing-form">
                <div class="search-landing-input-wrapper">
                    <i class="fas fa-search search-landing-icon"></i>
                    <input type="text" 
                           name="q" 
                           class="search-landing-input" 
                           placeholder="Search through technical documentation, code examples, and insights..."
                           autocomplete="off"
                           autofocus>
                    <button type="submit" class="search-landing-submit">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- Quick search suggestions -->
                <div class="search-landing-suggestions">
                    <div class="suggestions-header">
                        <i class="fas fa-lightbulb"></i>
                        <span>Popular searches:</span>
                    </div>
                    <div class="suggestions-list">
                        <a href="{% url 'blog:search' %}?q=machine+learning" class="suggestion-link">Machine Learning</a>
                        <a href="{% url 'blog:search' %}?q=python" class="suggestion-link">Python Development</a>
                        <a href="{% url 'blog:search' %}?q=api+design" class="suggestion-link">API Design</a>
                        <a href="{% url 'blog:search' %}?q=database" class="suggestion-link">Database</a>
                        <a href="{% url 'blog:search' %}?q=neural+networks" class="suggestion-link">Neural Networks</a>
                    </div>
                </div>
            </form>
            
        {% endglass_card %}
        
        <!-- Search Stats and Categories -->
        <div class="search-landing-grid">
            
            <!-- Search Statistics -->
            {% glass_card title="Archive Statistics" icon="fas fa-chart-bar" size="sm" %}
                
                <div class="search-stats-grid subnav-stats">
                    <div class="stat-item">
                        <span class="stat-value">{{ total_posts|default:"24" }}</span>
                        <span class="stat-label">DataLog Entries</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ categories.count }}</span>
                        <span class="stat-label">Categories</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ popular_tags.count }}</span>
                        <span class="stat-label">Topics</span>
                    </div>
                </div>
                
            {% endglass_card %}
            
            <!-- Browse Categories -->
            {% glass_card title="Browse by Category" icon="fas fa-folder" size="sm" %}
                
                <div class="category-browse-list">
                    {% for category in categories|slice:":6" %}
                    <a href="{% url 'blog:category' slug=category.slug %}" class="category-browse-item breadcrumb-item">
                        <div class="category-hex-mini" style="--hex-color: {{ category.color }};">
                            <span class="hex-code">{{ category.code|default:"CAT" }}</span>
                        </div>
                        <span class="category-name">{{ category.name }}</span>
                        <span class="category-count">({{ category.post_count }})</span>
                    </a>
                    {% endfor %}
                </div>
                
                <div class="browse-all-link">
                    <a href="{% url 'blog:categories' %}" class="browse-all-btn">
                        <span>View All Categories</span>
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                
            {% endglass_card %}
            
        </div>
        
    </div>
</section>
{% endif %}

{% endblock %}

{% block datalogs_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced search page initialization
    if (window.datalogInterface) {
        // Initialize search with AJAX for this page
        window.datalogInterface.initializeSearch({
            enableAjax: true,
            searchUrl: '{% url "blog:search_ajax" %}',
            autocompleteUrl: '{% url "blog:search_autocomplete" %}',
            minQueryLength: 2,
            debounceDelay: 300,
            maxSuggestions: 8,
            enableHighlighting: true
        });
        
        // Initialize enhanced filters for search results
        if (document.querySelector('.search-results-section')) {
            window.datalogInterface.initializeEnhancedFilters({
                container: '.search-results-section',
                autoApply: true,
                multiSelect: true,
                saveState: false // Don't save search filter state
            });
        }
        
        // Track search analytics
        const searchData = {
            query: '{{ query|escapejs }}',
            totalResults: {{ search_metadata.total_results|default:0 }},
            hasFilters: {{ active_filters|length > 0|yesno:"true,false" }},
            sortBy: '{{ search_metadata.sort_by|default:"relevance"|escapejs }}'
        };
        
        if (searchData.query) {
            window.datalogInterface.trackEvent('search_performed', {
                query_length: searchData.query.length,
                total_results: searchData.totalResults,
                has_filters: searchData.hasFilters,
                sort_method: searchData.sortBy,
                page_type: 'search_results'
            });
        } else {
            window.datalogInterface.trackEvent('search_landing_viewed', {
                page_type: 'search_landing'
            });
        }
        
        // Initialize search landing features
        const searchLandingInput = document.querySelector('.search-landing-input');
        if (searchLandingInput) {
            // Add search suggestions on focus
            searchLandingInput.addEventListener('focus', function() {
                if (!this.value) {
                    // Show popular searches or recent queries
                    window.datalogInterface.showSearchSuggestions(this, []);
                }
            });
            
            // Track landing page search
            searchLandingInput.closest('form').addEventListener('submit', function(e) {
                const query = searchLandingInput.value.trim();
                if (query) {
                    window.datalogInterface.trackEvent('search_from_landing', {
                        query_length: query.length,
                        source: 'landing_page'
                    });
                }
            });
        }
        
        // Initialize suggestion click tracking
        document.addEventListener('click', function(e) {
            const suggestionItem = e.target.closest('.suggestion-item, .suggestion-link');
            if (suggestionItem) {
                const suggestionType = suggestionItem.dataset.type || 'unknown';
                const suggestionText = suggestionItem.textContent.trim();
                
                window.datalogInterface.trackEvent('search_suggestion_clicked', {
                    suggestion_type: suggestionType,
                    suggestion_text: suggestionText,
                    query: '{{ query|escapejs }}',
                    position: Array.from(suggestionItem.parentNode.children).indexOf(suggestionItem)
                });
            }
        });
        
        // Initialize filter removal tracking
        document.addEventListener('click', function(e) {
            const removeFilterBtn = e.target.closest('.remove-filter-btn');
            if (removeFilterBtn) {
                const filterItem = removeFilterBtn.closest('.active-filter-item');
                const filterName = filterItem.querySelector('.filter-name').textContent;
                
                window.datalogInterface.trackEvent('search_filter_removed', {
                    filter_name: filterName,
                    query: '{{ query|escapejs }}',
                    remaining_filters: document.querySelectorAll('.active-filter-item').length - 1
                });
            }
            
            const clearAllBtn = e.target.closest('.clear-all-filters-btn');
            if (clearAllBtn) {
                window.datalogInterface.trackEvent('search_filters_cleared', {
                    query: '{{ query|escapejs }}',
                    total_filters_cleared: document.querySelectorAll('.active-filter-item').length
                });
            }
        });
        
        // Initialize no results tracking
        {% if query and not posts %}
        window.datalogInterface.trackEvent('search_no_results', {
            query: '{{ query|escapejs }}',
            query_length: '{{ query|length }}',
            has_filters: {{ active_filters|length > 0|yesno:"true,false" }}
        });
        {% endif %}
    }
});

// Search keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Focus search input with '/' key (like GitHub)
    if (e.key === '/' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        const searchInput = document.querySelector('.search-landing-input, .datalog-search-input');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // Clear search with Escape (when focused on search input)
    if (e.key === 'Escape' && e.target.matches('.search-landing-input, .datalog-search-input')) {
        e.target.value = '';
        e.target.blur();
    }
});

// Auto-focus search input on load (search landing page only)
{% if not query %}
window.addEventListener('load', function() {
    const searchInput = document.querySelector('.search-landing-input');
    if (searchInput && window.innerWidth > 768) { // Don't auto-focus on mobile
        setTimeout(() => {
            searchInput.focus();
        }, 500); // Small delay to avoid interfering with page load
    }
});
{% endif %}
</script>
{% endblock %}