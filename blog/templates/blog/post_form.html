{% extends "blog/base.html" %}
{% load static %}

{% block blog_content %}
<div class="form-container post-form">
  <!-- HUD corner accents -->
  <div class="hud-corner hud-corner-tl"></div>
  <div class="hud-corner hud-corner-tr"></div>
  <div class="hud-corner hud-corner-bl"></div>
  <div class="hud-corner hud-corner-br"></div>
  
  <h1 class="form-title">{{ title }}</h1>
  
  <form method="post" enctype="multipart/form-data" class="structured-form">
    {% csrf_token %}
    
    <div class="form-section">
      <h2 class="section-title">Post Details</h2>
      
      <div class="form-row">
        <div class="form-group col-md-8">
          <label for="{{ form.title.id_for_label }}">Title</label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="form-error">{{ form.title.errors }}</div>
          {% endif %}
        </div>
        
        <div class="form-group col-md-4">
          <label for="{{ form.status.id_for_label }}">Status</label>
          {{ form.status }}
          {% if form.status.errors %}
            <div class="form-error">{{ form.status.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-8">
          <label for="{{ form.excerpt.id_for_label }}">Excerpt</label>
          {{ form.excerpt }}
          <small class="form-text text-muted">{{ form.excerpt.help_text }}</small>
          {% if form.excerpt.errors %}
            <div class="form-error">{{ form.excerpt.errors }}</div>
          {% endif %}
        </div>
        
        <div class="form-group col-md-4">
          <label for="{{ form.category.id_for_label }}">Category</label>
          {{ form.category }}
          {% if form.category.errors %}
            <div class="form-error">{{ form.category.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-12">
          <label for="{{ form.tags.id_for_label }}">Tags</label>
          {{ form.tags }}
          {% if form.tags.errors %}
            <div class="form-error">{{ form.tags.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.thumbnail.id_for_label }}">Thumbnail Image</label>
          {{ form.thumbnail }}
          <small class="form-text text-muted">{{ form.thumbnail.help_text }}</small>
          {% if form.thumbnail.errors %}
            <div class="form-error">{{ form.thumbnail.errors }}</div>
          {% endif %}
          {% if post.thumbnail %}
            <div class="current-image">
              <img src="{{ post.thumbnail.url }}" alt="Current thumbnail" class="img-thumbnail">
            </div>
          {% endif %}
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.banner_image.id_for_label }}">Banner Image</label>
          {{ form.banner_image }}
          <small class="form-text text-muted">{{ form.banner_image.help_text }}</small>
          {% if form.banner_image.errors %}
            <div class="form-error">{{ form.banner_image.errors }}</div>
          {% endif %}
          {% if post.banner_image %}
            <div class="current-image">
              <img src="{{ post.banner_image.url }}" alt="Current banner" class="img-thumbnail">
            </div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-4">
          <div class="form-check">
            {{ form.featured }}
            <label class="form-check-label" for="{{ form.featured.id_for_label }}">
              Featured Post
            </label>
            <small class="form-text text-muted">{{ form.featured.help_text }}</small>
          </div>
        </div>
        
        <div class="form-group col-md-4">
          <div class="form-check">
            {{ form.show_toc }}
            <label class="form-check-label" for="{{ form.show_toc.id_for_label }}">
              Show Table of Contents
            </label>
            <small class="form-text text-muted">{{ form.show_toc.help_text }}</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Featured Code Section (only visible when featured is checked) -->
    <div class="form-section featured-code-section" style="display: none;">
      <h2 class="section-title">Featured Code Snippet</h2>
      
      <div class="form-row">
        <div class="form-group col-md-9">
          <label for="{{ form.featured_code.id_for_label }}">Featured Code</label>
          {{ form.featured_code }}
          <small class="form-text text-muted">{{ form.featured_code.help_text }}</small>
          {% if form.featured_code.errors %}
            <div class="form-error">{{ form.featured_code.errors }}</div>
          {% endif %}
        </div>
        
        <div class="form-group col-md-3">
          <label for="{{ form.featured_code_format.id_for_label }}">Code Language</label>
          {{ form.featured_code_format }}
          <small class="form-text text-muted">{{ form.featured_code_format.help_text }}</small>
          {% if form.featured_code_format.errors %}
            <div class="form-error">{{ form.featured_code_format.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Post Content Sections -->
    <div class="form-section">
      <h2 class="section-title">Post Content</h2>
      
      <!-- Introduction -->
      <div class="form-row">
        <div class="form-group col-md-12">
          <label for="{{ form.introduction.id_for_label }}">Introduction</label>
          {{ form.introduction }}
          <small class="form-text text-muted">{{ form.introduction.help_text }}</small>
        </div>
      </div>
      
      <!-- Content Sections -->
      {% for i in "12345" %}
      <div class="content-section" id="section-{{ i }}">
        <div class="form-row">
          <div class="form-group col-md-12">
            <label for="{{ form.section_i_title.id_for_label }}">Section {{ i }} Title</label>
            {{ form|get_field:"section_"|add:i|add:"_title" }}
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group col-md-12">
            <label for="{{ form.section_i_content.id_for_label }}">Section {{ i }} Content</label>
            {{ form|get_field:"section_"|add:i|add:"_content" }}
          </div>
        </div>
      </div>
      {% endfor %}
      
      <!-- Code Snippet -->
      <div class="form-row">
        <div class="form-group col-md-9">
          <label for="{{ form.code_snippet.id_for_label }}">Code Snippet</label>
          {{ form.code_snippet }}
        </div>
        
        <div class="form-group col-md-3">
          <label for="{{ form.code_language.id_for_label }}">Code Language</label>
          {{ form.code_language }}
        </div>
      </div>
      
      <!-- Conclusion -->
      <div class="form-row">
        <div class="form-group col-md-12">
          <label for="{{ form.conclusion.id_for_label }}">Conclusion</label>
          {{ form.conclusion }}
          <small class="form-text text-muted">{{ form.conclusion.help_text }}</small>
        </div>
      </div>
      
      <!-- Raw Markdown (optional/advanced) -->
      <div class="form-row">
        <div class="form-group col-md-12">
          <label>
            <input type="checkbox" id="toggle-raw-markdown"> 
            Advanced: Edit Raw Markdown
          </label>
          <div id="raw-markdown-container" style="display: none;">
            <label for="{{ form.content.id_for_label }}">Raw Markdown Content</label>
            {{ form.content }}
            <small class="form-text text-muted">Edit the raw markdown content directly (this will override the structured sections).</small>
            {% if form.content.errors %}
              <div class="form-error">{{ form.content.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Save Post</button>
      <a href="{% if post %}{% url 'blog:post_detail' slug=post.slug %}{% else %}{% url 'blog:post_list' %}{% endif %}" class="btn btn-outline-secondary">Cancel</a>
    </div>
      {% comment %} Preview Toggle  {% endcomment %}
      <div class="preview-toggle">
        <button type="button" class="btn btn-outline-cyan" id="toggle-preview">
          <i class="fas fa-eye me-1"></i> Toggle Preview
        </button>
      </div>
      {% comment %} End Preview Toggle  {% endcomment %}
  </form>
</div>

<!-- Add this after the form -->
<div class="post-preview" id="post-preview" style="display: none;">
    <h2 class="preview-title">Preview</h2>
    <div class="preview-content">
      <h1 id="preview-post-title"></h1>
      
      <div class="post-meta preview-meta">
        <span class="post-date">
          <i class="fas fa-calendar-alt me-1"></i> Today
        </span>
        <span class="post-meta-divider">|</span>
        <span class="post-reading-time">
          <i class="fas fa-clock me-1"></i> <span id="preview-reading-time">0</span> min read
        </span>
      </div>
      
      <div class="preview-body">
        <!-- Preview content will be inserted here -->
      </div>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle featured code section visibility based on featured checkbox
  const featuredCheckbox = document.getElementById('{{ form.featured.id_for_label }}');
  const featuredCodeSection = document.querySelector('.featured-code-section');
  
  if (featuredCheckbox && featuredCodeSection) {
    // Initial state
    featuredCodeSection.style.display = featuredCheckbox.checked ? 'block' : 'none';
    
    // Toggle on change
    featuredCheckbox.addEventListener('change', function() {
      featuredCodeSection.style.display = this.checked ? 'block' : 'none';
    });
  }
  
  // Toggle raw markdown editor
  const toggleRawMarkdown = document.getElementById('toggle-raw-markdown');
  const rawMarkdownContainer = document.getElementById('raw-markdown-container');
  
  if (toggleRawMarkdown && rawMarkdownContainer) {
    toggleRawMarkdown.addEventListener('change', function() {
      rawMarkdownContainer.style.display = this.checked ? 'block' : 'none';
    });
  }
  
  // Hide empty sections initially
  const contentSections = document.querySelectorAll('.content-section');
  let visibleSections = 1; // Always show at least section 1
  
  contentSections.forEach((section, index) => {
    const titleInput = section.querySelector('input[id$="_title"]');
    const contentTextarea = section.querySelector('textarea[id$="_content"]');
    
    if (index > 0) { // Skip section 1
      if ((titleInput && titleInput.value) || (contentTextarea && contentTextarea.value)) {
        visibleSections = index + 1;
      } else {
        section.style.display = 'none';
      }
    }
  });
  
  // Add "Add Section" button after the last visible section
  const lastVisibleSection = document.getElementById(`section-${visibleSections}`);
  if (lastVisibleSection && visibleSections < 5) {
    const addButton = document.createElement('button');
    addButton.type = 'button';
    addButton.className = 'btn btn-outline-cyan mt-3 mb-4';
    addButton.textContent = 'Add Section';
    addButton.addEventListener('click', function() {
      if (visibleSections < 5) {
        document.getElementById(`section-${visibleSections + 1}`).style.display = 'block';
        visibleSections++;
        
        // Move button after newly visible section
        if (visibleSections < 5) {
          this.parentNode.removeChild(this);
          document.getElementById(`section-${visibleSections}`).after(this);
        } else {
          this.parentNode.removeChild(this);
        }
      }
    });
    
    lastVisibleSection.after(addButton);
  }
});

// Add to the existing script in post_form.html
// Preview functionality
const togglePreviewBtn = document.getElementById('toggle-preview');
const previewSection = document.getElementById('post-preview');
const previewTitle = document.getElementById('preview-post-title');
const previewBody = document.querySelector('.preview-body');
const previewReadingTime = document.getElementById('preview-reading-time');

if (togglePreviewBtn && previewSection) {
  togglePreviewBtn.addEventListener('click', function() {
    if (previewSection.style.display === 'none') {
      updatePreview();
      previewSection.style.display = 'block';
      togglePreviewBtn.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide Preview';
      
      // Scroll to preview
      setTimeout(() => {
        previewSection.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    } else {
      previewSection.style.display = 'none';
      togglePreviewBtn.innerHTML = '<i class="fas fa-eye me-1"></i> Toggle Preview';
    }
  });
  
  // Update preview when content changes
  const formInputs = document.querySelectorAll('input, textarea, select');
  formInputs.forEach(input => {
    input.addEventListener('change', updatePreview);
    if (input.tagName === 'TEXTAREA') {
      input.addEventListener('keyup', debounce(updatePreview, 500));
    }
  });
  
  function updatePreview() {
    // Update title
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    previewTitle.textContent = titleInput.value || 'Post Title';
    
    // Build markdown content
    let markdownContent = '';
    
    // Introduction
    const introInput = document.getElementById('{{ form.introduction.id_for_label }}');
    if (introInput && introInput.value) {
      markdownContent += introInput.value + '\n\n';
    }
    
    // Sections
    for (let i = 1; i <= 5; i++) {
      const titleInput = document.querySelector(`[id$=section_${i}_title]`);
      const contentInput = document.querySelector(`[id$=section_${i}_content]`);
      
      if (titleInput && contentInput && titleInput.value) {
        markdownContent += `## ${titleInput.value}\n\n`;
        if (contentInput.value) {
          markdownContent += contentInput.value + '\n\n';
        }
      }
    }
    
    // Code snippet
    const codeInput = document.getElementById('{{ form.code_snippet.id_for_label }}');
    const langInput = document.getElementById('{{ form.code_language.id_for_label }}');
    
    if (codeInput && langInput && codeInput.value) {
      markdownContent += '```' + langInput.value + '\n';
      markdownContent += codeInput.value + '\n';
      markdownContent += '```\n\n';
    }
    
    // Conclusion
    const conclusionInput = document.getElementById('{{ form.conclusion.id_for_label }}');
    if (conclusionInput && conclusionInput.value) {
      markdownContent += '## Conclusion\n\n';
      markdownContent += conclusionInput.value + '\n\n';
    }
    
    // Raw markdown override
    const toggleRawMd = document.getElementById('toggle-raw-markdown');
    const rawMdInput = document.getElementById('{{ form.content.id_for_label }}');
    
    if (toggleRawMd && toggleRawMd.checked && rawMdInput && rawMdInput.value) {
      markdownContent = rawMdInput.value;
    }
    
    // Convert markdown to HTML
    fetch('/markdownx/markdownify/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCsrfToken(),
      },
      body: 'content=' + encodeURIComponent(markdownContent)
    })
    .then(response => response.json())
    .then(data => {
      previewBody.innerHTML = data.content;
      
      // Update reading time (very rough estimate)
      const wordCount = markdownContent.split(/\s+/).length;
      previewReadingTime.textContent = Math.max(1, Math.round(wordCount / 200));
      
      // Syntax highlight code blocks
      document.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
      });
    });
  }
  
  // Helper to get CSRF token
  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }
  
  // Debounce function to limit how often a function is called
  function debounce(func, wait) {
    let timeout;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        func.apply(context, args);
      }, wait);
    };
  }
}

// Add to the existing script in post_form.html
// Auto-save functionality
const autoSaveKey = 'blog_post_autosave_{{ post.id|default:"new" }}';
const autoSaveStatus = document.createElement('div');
autoSaveStatus.className = 'auto-save-status';
autoSaveStatus.innerHTML = '<i class="fas fa-sync"></i> Auto-save ready';
document.querySelector('.form-actions').appendChild(autoSaveStatus);

// Load auto-saved content
function loadAutoSavedContent() {
  const savedData = localStorage.getItem(autoSaveKey);
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      const timestamp = new Date(data.timestamp);
      const now = new Date();
      const diff = Math.floor((now - timestamp) / 1000 / 60); // Minutes
      
      // Only restore if less than 1 day old
      if (diff < 1440) {
        // Ask user if they want to restore
        if (confirm(`Restore auto-saved draft from ${diff < 60 ? diff + ' minutes' : Math.floor(diff/60) + ' hours'} ago?`)) {
          // Restore form data
          Object.keys(data.formData).forEach(key => {
            const input = document.querySelector(`[name="${key}"]`);
            if (input) {
              if (input.type === 'checkbox') {
                input.checked = data.formData[key] === 'true';
              } else if (input.tagName === 'SELECT' && input.multiple) {
                // Handle multi-select
                const values = data.formData[key].split(',');
                Array.from(input.options).forEach(option => {
                  option.selected = values.includes(option.value);
                });
              } else {
                input.value = data.formData[key];
              }
            }
          });
          
          // Update UI
          if (featuredCheckbox) {
            featuredCodeSection.style.display = featuredCheckbox.checked ? 'block' : 'none';
          }
          
          autoSaveStatus.innerHTML = '<i class="fas fa-check-circle"></i> Restored auto-saved draft';
          autoSaveStatus.classList.add('restored');
          
          setTimeout(() => {
            autoSaveStatus.classList.remove('restored');
          }, 3000);
        }
      } else {
        // Clear old autosave
        localStorage.removeItem(autoSaveKey);
      }
    } catch (e) {
      console.error('Error loading auto-saved content', e);
      localStorage.removeItem(autoSaveKey);
    }
  }
}

// Auto-save form content
function autoSaveContent() {
  const form = document.querySelector('form.structured-form');
  if (!form) return;
  
  const formData = {};
  const formElements = form.elements;
  
  for (let i = 0; i < formElements.length; i++) {
    const element = formElements[i];
    if (element.name && element.name !== 'csrfmiddlewaretoken') {
      if (element.type === 'checkbox') {
        formData[element.name] = element.checked.toString();
      } else if (element.tagName === 'SELECT' && element.multiple) {
        const selectedValues = Array.from(element.selectedOptions).map(option => option.value).join(',');
        formData[element.name] = selectedValues;
      } else {
        formData[element.name] = element.value;
      }
    }
  }
  
  const saveData = {
    formData: formData,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem(autoSaveKey, JSON.stringify(saveData));
  
  // Update status
  autoSaveStatus.innerHTML = '<i class="fas fa-check-circle"></i> Auto-saved';
  autoSaveStatus.classList.add('saved');
  
  setTimeout(() => {
    autoSaveStatus.classList.remove('saved');
    autoSaveStatus.innerHTML = '<i class="fas fa-sync"></i> Auto-save ready';
  }, 2000);
}

// Set up auto-save
let autoSaveTimer;
const formInputs = document.querySelectorAll('input, textarea, select');
formInputs.forEach(input => {
  input.addEventListener('change', () => {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(autoSaveContent, 1000);
  });
  
  if (input.tagName === 'TEXTAREA') {
    input.addEventListener('keyup', () => {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(autoSaveContent, 3000);
    });
  }
});

// Load auto-saved content when page loads
loadAutoSavedContent();

// Set up auto-save interval
setInterval(autoSaveContent, 60000); // Auto-save every minute
</script>
{% endblock %}