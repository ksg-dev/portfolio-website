
<!----
 * AURA Portfolio - Blog/Datalogs App Base Template
 * Advanced User Repository & Archive - Complete Foundation
 * Version: 2.1.3 - Cleaned/Optimized
---->

{% extends "base.html" %}
{% load static %}

{% load aura_filters %}
{% load aura_components%}
{% load blog_tags %}

{% block title %}{% block datalogs_title %}DataLogs Archive{% endblock %} | AURA DataLogs{% endblock %}

{% block extra_css %}
<!-- DataLogs App Specific Styles -->
<link rel="stylesheet" href="{% static 'blog/css/datalogs.css' %}">

{% pygments_css %}
{% block datalogs_css %}{% endblock %}
{% endblock %}

{% block body_class %}datalogs-interface{% endblock %}


{% block subnav %}
<!-- DataLogs Sub-Navigation -->
<nav class="app-subnav datalogs-subnav" id="datalogsSubnav">
    <div class="container subnav-container">
        
        <div class="subnav-left">
            <!-- DataLogs Brand/Title -->
            <div class="subnav-title">
                <i class="fas fa-database subnav-title-icon"></i>
                <span>DataLogs</span>
            </div>
            
            <!-- DataLogs Navigation Links -->
            <div class="subnav-links">
                <a href="{% url 'blog:post_list' %}" class="subnav-link {% active_nav 'blog:post_list' %}">
                    <i class="fas fa-list subnav-icon"></i>
                    <span>All Logs</span>
                </a>
                <a href="{% url 'blog:archive' %}" class="subnav-link {% active_nav 'blog:archive' %}">
                    <i class="fas fa-history subnav-icon"></i>
                    <span>Archive</span>
                </a>
                <a href="{% url 'blog:tags' %}" class="subnav-link {% active_nav 'blog:tags' %}">
                    <i class="fas fa-tags subnav-icon"></i>
                    <span>Tags</span>
                </a>
                <!-- Categories Dropdown -->
                <div class="subnav-dropdown">
                    <button class="subnav-link dropdown-toggle {% if current_category %}active{% endif %}" 
                            type="button" 
                            id="categoriesDropdown" 
                            aria-expanded="false">
                        <i class="fas fa-folder subnav-icon"></i>
                        <span>{% if current_category %}{{ current_category.name }}{% else %}Categories{% endif %}</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <ul class="aura-dropdown-menu" aria-labelledby="categoriesDropdown">
                        <li>
                            <a class="dropdown-item aura-dropdown-item" href="{% url 'blog:post_list' %}">
                                <i class="fas fa-list dropdown-item-icon"></i>
                                <span class="dropdown-item-text">All Categories</span>
                                <span class="dropdown-item-count">{{ total_posts|default:"24" }}</span>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider aura-dropdown-divider"></li>
                        {% for category in categories %}
                        <li>
                            <a class="dropdown-item aura-dropdown-item {% if category.slug == current_category %}active{% endif %}" 
                               href="{% url 'blog:category' slug=category.slug %}">
                                <div class="category-hexagon-mini" style="--hex-color: {{ category.color }};">
                                    <span class="hexagon-text-mini">{{ category.code }}</span>
                                </div>
                                <span class="dropdown-item-text">{{ category.name }}</span>
                                <span class="dropdown-item-count">{{ category.posts.count|default:"0" }}</span>
                            </a>
                        </li>
                        {% endfor %}
                        {% if categories.count > 0 %}
                        <li><hr class="dropdown-divider aura-dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item aura-dropdown-item dropdown-item-special" href="#">
                                <i class="fas fa-plus dropdown-item-icon"></i>
                                <span class="dropdown-item-text">Manage Categories</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                <a href="#" class="subnav-link" id="analyticsLink">
                    <i class="fas fa-chart-bar subnav-icon"></i>
                    <span>Analytics</span>
                </a>
            </div>
                </div>
        
        <div class="subnav-right">
            <!-- Real-time DataLog Metrics -->
            <div class="subnav-stats">
                <div class="stat-item">
                    <i class="fas fa-file-alt"></i>
                    <span class="stat-value">{{ total_posts|default:"24" }}</span>
                    <span class="stat-label">Entries</span>
                </div>
                <span class="stat-separator">|</span>
                <div class="stat-item">
                    <i class="fas fa-eye"></i>
                    <span class="stat-value">{{ total_views|default:"1.2K" }}</span>
                    <span class="stat-label">Views</span>
                </div>
                <span class="stat-separator">|</span>
                <div class="stat-item">
                    <i class="fas fa-tags"></i>
                    <span class="stat-value">{{ total_tags|default:"18" }}</span>
                    <span class="stat-label">Tags</span>
                </div>
                <span class="stat-separator">|</span>
                <div class="stat-item">
                    <i class="fas fa-folder"></i>
                    <span class="stat-value">{{ total_categories|default:"5" }}</span>
                    <span class="stat-label">Categories</span>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="subnav-actions">
                {% if user.is_authenticated %}
                <a href="{% url 'blog:post_create' %}" class="subnav-action-btn">
                    <i class="fas fa-plus"></i>
                    <span>New Entry</span>
                </a>
                {% endif %}
                <button class="subnav-action-btn" id="datalogsFilterToggle">
                    <i class="fas fa-filter"></i>
                    <span>Filters</span>
                </button>
                <button class="subnav-action-btn" id="datalogsViewToggle">
                    <i class="fas fa-th-large"></i>
                    <span>View</span>
                </button>
                <button class="subnav-action-btn" id="datalogsSearchToggle">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                </button>
            </div>
        </div>
        
    </div>
    
    <!-- DataLogs Scanning Line -->
    <div class="subnav-scanning-line"></div>
</nav>
{% endblock %}

{% block breadcrumbs %}
{% if show_breadcrumbs %}
<div class="container">
    <nav class="datalogs-breadcrumbs">
        <div class="breadcrumb-container">
            <a href="{% url 'core:home' %}" class="breadcrumb-item">
                <i class="fas fa-home"></i>
                <span>AURA</span>
            </a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <a href="{% url 'blog:post_list' %}" class="breadcrumb-item">
                <i class="fas fa-database"></i>
                <span>DataLogs</span>
            </a>
            {% block datalogs_breadcrumbs %}{% endblock %}
        </div>
        
        <!-- Optional Category/Status Indicators -->
        {% if current_post %}
        <div class="breadcrumb-status">
            <div class="status-indicator {{ current_post.status|default:'published' }}"></div>
            <span class="status-text">{{ current_post.get_status_display|upper|default:"PUBLISHED" }}</span>
            {% if current_post.category %}
            <span class="category-code">{{ current_post.category.code }}</span>
            {% endif %}
        </div>
        {% elif current_category %}
        <div class="breadcrumb-status">
            <div class="category-indicator" style="color: {{ current_category.color }};">
                <span class="category-code">{{ current_category.code }}</span>
            </div>
            <span class="status-text">{{ current_category.name|upper }}</span>
        </div>
        {% endif %}
    </nav>
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- DataLogs Interface Container -->
<div class="datalogs-interface-container">
    
    <!-- DataLogs Filter Panel (Collapsible) -->
    {% if show_filters %}
    <div class="datalogs-filter-panel" id="datalogsFilterPanel" style="display: none;">
        <div class="filter-panel-header">
            <h3 class="filter-title">
                <i class="fas fa-sliders-h"></i>
                DataLog Filters
            </h3>
            <button class="filter-close" id="closeFilters">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="filter-panel-content">
            <form method="get" class="filter-form" id="datalogsFilterForm">
                
                <!-- Category Filter -->
                <div class="filter-group">
                    <label class="filter-label">Categories</label>
                    <div class="filter-options">
                        {% for category in categories %}
                        <label class="filter-checkbox">
                            <input type="checkbox" name="category" value="{{ category.slug }}" {% if category.slug in request.GET.category %}checked{% endif %}>
                            <span class="category-badge" style="--category-color: {{ category.color }};">{{ category.code }}</span>
                            <span>{{ category.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Tag Filter -->
                <div class="filter-group">
                    <label class="filter-label">Tags</label>
                    <div class="filter-search">
                        <input type="text" class="tag-search" placeholder="Search tags..." id="tagSearch">
                    </div>
                    <div class="filter-options tag-filters" id="tagFilters">
                        {% for tag in tags %}
                        <label class="filter-checkbox tag-option" data-tag="{{ tag.name|lower }}">
                            <input type="checkbox" name="tag" value="{{ tag.slug }}" {% if tag.slug in request.GET.tag %}checked{% endif %}>
                            <span class="tag-badge">{{ tag.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Date Range Filter -->
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="filter-date-range">
                        <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="filter-date-input">
                        <span class="date-separator">to</span>
                        <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="filter-date-input">
                    </div>
                </div>
                
                <!-- Reading Time Filter -->
                <div class="filter-group">
                    <label class="filter-label">Reading Time</label>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" name="reading_time" value="quick" {% if 'quick' in request.GET.reading_time %}checked{% endif %}>
                            <span>Quick Read (< 5 min)</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" name="reading_time" value="medium" {% if 'medium' in request.GET.reading_time %}checked{% endif %}>
                            <span>Medium Read (5-15 min)</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" name="reading_time" value="long" {% if 'long' in request.GET.reading_time %}checked{% endif %}>
                            <span>Deep Dive (15+ min)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Featured Filter -->
                <div class="filter-group">
                    <label class="filter-label">Special</label>
                    <div class="filter-options">
                        <label class="filter-checkbox">
                            <input type="checkbox" name="featured" value="true" {% if request.GET.featured %}checked{% endif %}>
                            <span class="featured-badge">Featured Entries</span>
                        </label>
                        <label class="filter-checkbox">
                            <input type="checkbox" name="has_code" value="true" {% if request.GET.has_code %}checked{% endif %}>
                            <span class="code-badge">Code Examples</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                    <button type="button" class="btn btn-outline" id="clearFilters">
                        <i class="fas fa-times"></i>
                        Clear All
                    </button>
                </div>
                
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- DataLogs Search Panel -->
    <div class="datalogs-search-panel" id="datalogsSearchPanel" style="display: none;">
        <div class="search-panel-content">
            <form method="get" class="search-form" action="{% url 'blog:search' %}">
                <div class="datalog-search-container">
                    <i class="fas fa-search datalog-search-icon"></i>
                    <input type="text" 
                           name="q" 
                           class="datalog-search-input" 
                           placeholder="Search through DataLog entries..."
                           value="{{ query|default:'' }}"
                           autocomplete="off">
                    <button type="submit" class="search-submit-btn">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                    <!-- Dynamic search suggestions will be populated here -->
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main DataLogs Content Area -->
    <div class="datalogs-content-area">
        <div class="container">
            
            <!-- Page Header Section -->
            {% block datalogs_header %}
            {% if page_title %}
            {% section_header title=page_title subtitle=page_subtitle icon=page_icon show_metrics=show_header_metrics %}
            {% endif %}
            {% endblock %}
            
            <!-- Alert/Notification Bar -->
            {% if messages %}
            <div class="datalogs-alerts">
                {% for message in messages %}
                {% alert_box message message.tags dismissible=True %}
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- DataLog Stats (Optional) -->
            {% if show_stats %}
            <div class="datalog-stats-grid">
                <div class="datalog-stat-card">
                    <span class="datalog-stat-value">{{ total_posts|format_number }}</span>
                    <span class="datalog-stat-label">Total Entries</span>
                </div>
                <div class="datalog-stat-card">
                    <span class="datalog-stat-value">{{ total_words|format_number }}</span>
                    <span class="datalog-stat-label">Words Written</span>
                </div>
                <div class="datalog-stat-card">
                    <span class="datalog-stat-value">{{ avg_reading_time|default:"8" }}min</span>
                    <span class="datalog-stat-label">Avg Read Time</span>
                </div>
                <div class="datalog-stat-card">
                    <span class="datalog-stat-value">{{ total_views|format_number }}</span>
                    <span class="datalog-stat-label">Total Views</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Main Content Block -->
            <main class="datalogs-main-content">
                {% block datalogs_content %}
                <!-- Individual datalog pages will override this -->
                {% endblock %}
            </main>
            
        </div>
    </div>
    
</div>

<!-- DataLogs Analytics Overlay -->
<div class="datalogs-data-overlay" id="datalogsDataOverlay">
    <div class="data-stream" id="datalogsDataStream">
        <h3 class="data-stream-title">
            <i class="fas fa-chart-bar"></i>
            DataLog Analytics
        </h3>
        <!-- Real-time analytics data will be populated here -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Remove Bootstrap JavaScript - we'll use custom dropdown -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->

<script src="{% static 'blog/js/datalogs.js' %}"></script>
{% block datalogs_js %}{% endblock %}

<!-- Initialize DataLogs Interface -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize datalogs interface
    if (typeof initDatalogsInterface === 'function') {
        initDatalogsInterface();
    }
    
    // Initialize custom AURA dropdowns (no Bootstrap needed)
    initializeCustomDropdowns();
    
    // Filter toggle functionality
    const filterToggle = document.getElementById('datalogsFilterToggle');
    const filterPanel = document.getElementById('datalogsFilterPanel');
    const closeFilters = document.getElementById('closeFilters');
    
    if (filterToggle && filterPanel) {
        filterToggle.addEventListener('click', function() {
            const isVisible = filterPanel.style.display !== 'none';
            filterPanel.style.display = isVisible ? 'none' : 'block';
            this.classList.toggle('active', !isVisible);
            
            // Close search panel if open
            const searchPanel = document.getElementById('datalogsSearchPanel');
            if (searchPanel && searchPanel.style.display !== 'none') {
                searchPanel.style.display = 'none';
                document.getElementById('datalogsSearchToggle')?.classList.remove('active');
            }
        });
    }
    
    if (closeFilters && filterPanel) {
        closeFilters.addEventListener('click', function() {
            filterPanel.style.display = 'none';
            filterToggle?.classList.remove('active');
        });
    }
    
    // Search toggle functionality
    const searchToggle = document.getElementById('datalogsSearchToggle');
    const searchPanel = document.getElementById('datalogsSearchPanel');
    
    if (searchToggle && searchPanel) {
        searchToggle.addEventListener('click', function() {
            const isVisible = searchPanel.style.display !== 'none';
            searchPanel.style.display = isVisible ? 'none' : 'block';
            this.classList.toggle('active', !isVisible);
            
            // Close filter panel if open
            if (filterPanel && filterPanel.style.display !== 'none') {
                filterPanel.style.display = 'none';
                filterToggle?.classList.remove('active');
            }
            
            // Focus search input when opening
            if (!isVisible) {
                const searchInput = searchPanel.querySelector('.datalog-search-input');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
        });
    }
    
    // View toggle functionality
    const viewToggle = document.getElementById('datalogsViewToggle');
    if (viewToggle) {
        viewToggle.addEventListener('click', function() {
            const contentArea = document.querySelector('.datalogs-main-content');
            if (contentArea) {
                contentArea.classList.toggle('grid-view');
                contentArea.classList.toggle('list-view');
                
                const icon = this.querySelector('i');
                if (contentArea.classList.contains('grid-view')) {
                    icon.className = 'fas fa-list';
                } else {
                    icon.className = 'fas fa-th-large';
                }
            }
        });
    }
    
    // Tag search functionality
    const tagSearch = document.getElementById('tagSearch');
    const tagOptions = document.querySelectorAll('.tag-option');
    
    if (tagSearch && tagOptions.length > 0) {
        tagSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            tagOptions.forEach(option => {
                const tagName = option.dataset.tag;
                if (tagName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        });
    }
    
    // Search suggestions functionality
    const searchInput = document.querySelector('.datalog-search-input');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    if (searchInput && searchSuggestions) {
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    loadSearchSuggestions(query);
                }, 300);
            } else {
                searchSuggestions.style.display = 'none';
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchPanel?.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        });
    }
    
    // Analytics link functionality
    const analyticsLink = document.getElementById('analyticsLink');
    if (analyticsLink) {
        analyticsLink.addEventListener('click', function(e) {
            e.preventDefault();
            toggleAnalyticsOverlay();
        });
    }
    
    // Clear filters functionality
    const clearFilters = document.getElementById('clearFilters');
    if (clearFilters) {
        clearFilters.addEventListener('click', function() {
            const form = document.getElementById('datalogsFilterForm');
            if (form) {
                form.reset();
                // Redirect to clean URL
                window.location.href = window.location.pathname;
            }
        });
    }
    
    // Date range validation
    const dateFrom = document.querySelector('input[name="date_from"]');
    const dateTo = document.querySelector('input[name="date_to"]');
    
    if (dateFrom && dateTo) {
        dateFrom.addEventListener('change', function() {
            if (dateTo.value && this.value > dateTo.value) {
                dateTo.value = this.value;
            }
        });
        
        dateTo.addEventListener('change', function() {
            if (dateFrom.value && this.value < dateFrom.value) {
                dateFrom.value = this.value;
            }
        });
    }
    
    // DataLogs-specific initialization
    {% block datalogs_inline_js %}{% endblock %}
});

// Search suggestions loader
function loadSearchSuggestions(query) {
    const searchSuggestions = document.getElementById('searchSuggestions');
    if (!searchSuggestions) return;
    
    // Simulate search suggestions (replace with actual API call)
    const suggestions = [
        'Machine Learning Fundamentals',
        'Python Data Analysis',
        'Django Best Practices',
        'API Development',
        'Database Optimization'
    ].filter(suggestion => 
        suggestion.toLowerCase().includes(query.toLowerCase())
    );
    
    if (suggestions.length > 0) {
        searchSuggestions.innerHTML = suggestions.map(suggestion => 
            `<div class="search-suggestion-item" onclick="selectSuggestion('${suggestion}')">
                <i class="fas fa-search"></i>
                <span>${suggestion}</span>
            </div>`
        ).join('');
        searchSuggestions.style.display = 'block';
    } else {
        searchSuggestions.style.display = 'none';
    }
}

// Select search suggestion
function selectSuggestion(suggestion) {
    const searchInput = document.querySelector('.datalog-search-input');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    if (searchInput) {
        searchInput.value = suggestion;
        searchSuggestions.style.display = 'none';
        
        // Submit search
        const searchForm = searchInput.closest('form');
        if (searchForm) {
            searchForm.submit();
        }
    }
}

// Analytics overlay toggle
function toggleAnalyticsOverlay() {
    const overlay = document.getElementById('datalogsDataOverlay');
    if (overlay) {
        overlay.classList.toggle('active');
        
        if (overlay.classList.contains('active')) {
            loadDatalogAnalytics();
        }
    }
}

// Load datalog analytics
function loadDatalogAnalytics() {
    const dataStream = document.getElementById('datalogsDataStream');
    if (dataStream) {
        // Simulate analytics data (replace with actual API call)
        const analytics = [
            { label: 'Most Popular Category', value: 'Machine Learning' },
            { label: 'Avg Words per Entry', value: '1,247' },
            { label: 'Total Reading Time', value: '127h' },
            { label: 'Top Tag', value: '#python' },
            { label: 'Engagement Rate', value: '84%' }
        ];
        
        const analyticsHTML = analytics.map(metric => 
            `<div class="metric-stream-item">
                <span class="metric-label">${metric.label}:</span>
                <span class="metric-value">${metric.value}</span>
            </div>`
        ).join('');
        
        // Append to existing title
        const existingTitle = dataStream.querySelector('.data-stream-title');
        if (existingTitle) {
            dataStream.innerHTML = existingTitle.outerHTML + analyticsHTML;
        } else {
            dataStream.innerHTML = analyticsHTML;
        }
    }
}

// Real-time search with debouncing
function setupRealTimeSearch() {
    const searchInput = document.querySelector('.datalog-search-input');
    if (searchInput) {
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length >= 3) {
                searchTimeout = setTimeout(() => {
                    // Perform real-time search
                    performRealTimeSearch(query);
                }, 500);
            }
        });
    }
}

function performRealTimeSearch(query) {
    // This would typically make an AJAX call to your search endpoint
    console.log('Searching for:', query);
    
    // Example: Update URL with search parameter
    const url = new URL(window.location);
    url.searchParams.set('q', query);
    
    // You could use fetch() here to get results without page reload
    // fetch('/blog/search/?q=' + encodeURIComponent(query))
    //     .then(response => response.json())
    //     .then(data => updateSearchResults(data));
}

// Category color theming
function applyCategoryTheming() {
    const categoryElements = document.querySelectorAll('[data-category-color]');
    categoryElements.forEach(element => {
        const color = element.dataset.categoryColor;
        if (color) {
            element.style.setProperty('--category-accent', color);
        }
    });
}

// Custom AURA Dropdown System (No Bootstrap needed)
function initializeCustomDropdowns() {
    console.log('🚀 Initializing custom AURA dropdowns...');
    
    const dropdowns = document.querySelectorAll('.subnav-dropdown');
    
    dropdowns.forEach(dropdown => {
        const toggle = dropdown.querySelector('.dropdown-toggle');
        const menu = dropdown.querySelector('.aura-dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (!toggle || !menu) {
            console.warn('⚠️ Dropdown elements not found:', dropdown);
            return;
        }
        
        console.log('✅ Setting up dropdown:', toggle);
        
        // Toggle dropdown on click
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('🖱️ Dropdown clicked');
            
            // Close all other dropdowns first
            closeAllDropdowns();
            
            // Toggle current dropdown
            const isOpen = menu.classList.contains('show');
            
            if (!isOpen) {
                openDropdown(dropdown, toggle, menu, arrow);
            }
        });
        
        // Keyboard support
        toggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggle.click();
            } else if (e.key === 'Escape') {
                closeDropdown(dropdown, menu, arrow);
            }
        });
        
        // Prevent menu clicks from closing dropdown
        menu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Handle dropdown item clicks
        const dropdownItems = menu.querySelectorAll('.aura-dropdown-item');
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // Update toggle text if it's a category selection
                if (this.href && this.href.includes('category')) {
                    const categoryName = this.querySelector('.dropdown-item-text')?.textContent;
                    const toggleText = toggle.querySelector('span');
                    
                    if (categoryName && toggleText && categoryName !== 'All Categories') {
                        toggleText.textContent = categoryName;
                        toggle.classList.add('active');
                    } else if (categoryName === 'All Categories') {
                        toggleText.textContent = 'Categories';
                        toggle.classList.remove('active');
                    }
                }
                
                // Close dropdown after selection
                setTimeout(() => {
                    closeDropdown(dropdown, menu, arrow);
                }, 100);
            });
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.subnav-dropdown')) {
            closeAllDropdowns();
        }
    });
    
    // Close dropdowns on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllDropdowns();
                }
            });
    
    console.log('✅ Custom dropdowns initialized successfully');
}

function openDropdown(dropdown, toggle, menu, arrow) {
    console.log('📂 Opening dropdown');
    
    // Position dropdown to connect directly with button
    const rect = toggle.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const menuHeight = 400; // estimated max height
    
    // Reset positioning
    menu.style.position = 'fixed';
    menu.style.left = rect.left + 'px';
    menu.style.minWidth = Math.max(280, rect.width) + 'px';
    menu.style.zIndex = '2000';
    
    // Position directly at the bottom of the button (no gap)
    menu.style.top = (rect.bottom - 1) + 'px'; // -1px to overlap border
    menu.style.transform = 'translateY(0)';
    
    // Check if dropdown would go below viewport
    if (rect.bottom + menuHeight > viewportHeight) {
        // If not enough space below, position above instead
        menu.style.top = (rect.top - menuHeight + 1) + 'px'; // +1px to overlap border
        menu.style.transform = 'translateY(0)';
    }
    
    // Show dropdown with animation
    menu.style.opacity = '0';
    menu.style.transform = 'translateY(-3px) scale(0.98)'; // Subtle animation
    menu.classList.add('show');
    menu.style.display = 'block';
    
    // Add connected styling to button
    toggle.classList.add('dropdown-open');
    
    // Animate in
    requestAnimationFrame(() => {
        menu.style.opacity = '1';
        menu.style.transform = 'translateY(0) scale(1)';
    });
    
    // Rotate arrow
    if (arrow) {
        arrow.style.transform = 'rotate(180deg)';
    }
    
    // Mark toggle as active
    toggle.setAttribute('aria-expanded', 'true');
}

function closeDropdown(dropdown, menu, arrow) {
    console.log('📁 Closing dropdown');
    
    // Animate out
    menu.style.opacity = '0';
    menu.style.transform = 'translateY(-10px) scale(0.95)';
    
    // Hide after animation
    setTimeout(() => {
        menu.classList.remove('show');
        menu.style.display = 'none';
    }, 150);
    
    // Reset arrow
    if (arrow) {
        arrow.style.transform = 'rotate(0deg)';
    }
    
    // Mark toggle as inactive
    const toggle = dropdown.querySelector('.dropdown-toggle');
    if (toggle) {
        toggle.setAttribute('aria-expanded', 'false');
        toggle.classList.remove('dropdown-open');
                }
}

function closeAllDropdowns() {
    console.log('🔒 Closing all dropdowns');
    
    const openDropdowns = document.querySelectorAll('.subnav-dropdown');
    openDropdowns.forEach(dropdown => {
        const menu = dropdown.querySelector('.aura-dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (menu && menu.classList.contains('show')) {
            closeDropdown(dropdown, menu, arrow);
        }
    });
}

// Category dropdown specific functionality
function setupCategoryDropdown() {
    const categoryDropdown = document.getElementById('categoriesDropdown');
    
    if (categoryDropdown) {
        console.log('📁 Setting up category dropdown functionality');
        
        // Check if we're on a category page and update button text
        const currentPath = window.location.pathname;
        if (currentPath.includes('/category/')) {
            const categorySlug = currentPath.split('/category/')[1].replace('/', '');
            const categoryItem = document.querySelector(`[href*="category/${categorySlug}"]`);
        
            if (categoryItem) {
                const categoryName = categoryItem.querySelector('.dropdown-item-text')?.textContent;
                const toggleText = categoryDropdown.querySelector('span');
                
                if (categoryName && toggleText) {
                    toggleText.textContent = categoryName;
                    categoryDropdown.classList.add('active');
            }
            }
        }
    }
}

// Add smooth scrolling for dropdown if content is long
function handleDropdownScrolling() {
    const dropdownMenus = document.querySelectorAll('.aura-dropdown-menu');
    
    dropdownMenus.forEach(menu => {
        // Prevent wheel events from bubbling to parent
        menu.addEventListener('wheel', function(e) {
        e.stopPropagation();
            
            // Check if scrolling is needed
            const isScrollable = menu.scrollHeight > menu.clientHeight;
            
            if (!isScrollable) {
                e.preventDefault();
                return;
            }
            
            // Handle scroll bounds
            const atTop = menu.scrollTop === 0;
            const atBottom = menu.scrollTop >= menu.scrollHeight - menu.clientHeight;
        
            if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                e.preventDefault();
            }
        });
    });
}

// Initialize everything
setTimeout(() => {
    setupCategoryDropdown();
    handleDropdownScrolling();
}, 100);
</script>
{% endblock %}
                